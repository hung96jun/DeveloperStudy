<font color="red">스레드</font> 역시 프로세스처럼 <font color="red">명령어를 한 줄씩 실행하는 기본 단위</font>이다.
- 한 프로세스 안에 여러 스레드가 있다.
- 한 프로세스 안에 있는 스레드는 프로세스 안 메모리 공간을 공유한다.
- 각 스레드마다 스택을 가지는데, 이는 스레드마다 실행되는 함수의 로컬 변수들이 있다는 것을 의미한다.
![[Pasted image 20231027062711.png|400]]
프로그램을 실행할 때 <font color="red">기본으로 존재하는 스레드</font>를 ==메인 스레드==한다. 이러한 <font color="red">스레드가 하나만 실행</font>되는 프로그램을 ==싱글 스레드==프로그램이라 하며 싱글 스레드로만 작동하도록 프로그램을 설계하고 구현하는 것을 ==싱글 스레==드 모델**이라 한다.
![[Pasted image 20231027063629.png|400]]

--------------
여러 프로세스나 스레드를 동시에 실행해야 하는 운영체제는 ==스레드들을 일정 시간마다 번갈아 가면서 실행==한다. 각 스레드를 실행하다 말고 다른 스레드로 이동하는 과정을 <font color="red">컨텍스트 스위치(Context Switch)</font>라 한다.
![[Pasted image 20231027065250.png]]
컨텍스트 스위치를 하는 과정은 ==적지 않은 연산을 발생==시키는데, 실행 중이던 스레드의 상태를 저장하고 실행할 스레드의 상태를 복원하고 그 지점으로 이동해야 한다. 그래서 컨텍스트 스위치를 너무 자주 하게 되면 정작 스레드를 처리하는 시간보다 이동하는 시간이 더 많아지게 되어 비효율적이게 된다.

컨텍스트 스위치 횟수를 최대로 줄이는것도 문제가 될 수 있다. 예를 들어 로딩 중 애니메이션이 보이는 경우, 애니메이션이 끊겨 보이게 된다. 결론적으로 컨텍스트 스위치 실행은 기본적으로 ==사람 입장에서 쾌적할 수 있는== 가급적 긴 시간 단위로 이루어진다. 이 시간 단위를 <font color="red">타임 슬라이스(Time Slice)</font>라고 한다.(사람 입장에서는 짧지만, 컴퓨터 입장에서는 긴 시간이다.)

---------
스레드를 다룰 때 주의 사항
컴퓨터가 실행되는 명령어는 기본적으로 기계어 명령어 단위로 실행된다. 컨텍스트 스위치도 마찬가지로 ==기계어 명령어 단위==로 일어나며 한 기계어 명령어를 다 실행하고 나면 컨텍스트 스위치를 한다.
프로그래밍은 ==한 구문을 실제론 여러 기계어 명령어로 컴파일==한다. ==소스의 한 줄 구문 안에 있는 것을 실행하다 말고 컨텍스트 스위치를 할 가능성==이 있다는 것이다.

예를 들어 스레드 2개가 하나의 값에 접근하는 경우에, 두 스레드가 한 값에 접근하는 것이 특별한 조치를 하지 않으면 그 값은 어떤 상태가 될지 모르게 된다. ==여러 스레드가 데이터에 접근해서 그 데이터 상태를 예측할 수 없게 하는 것==을<font color="red">경쟁 상태 혹은 데이터 레이스</font>라 한다.
- 원자성(Atomicity) : 어떤 데이터를 스레드가 접근하고 있을 때 그 데이터를 모두 바꾸든지, 아니면 하나도 바꾸지 않든지 해야 한다.
- 일관성(Consistency) : 데이터를 항상 일관성 있는 상태로 유지해야 한다.
원자성과 일관성을 유지하기 위해 ==동기화(Synchronize)==가 필요하며 대표적으로 <font color="red">임계 영역, 뮤텍스(상호 배제), 잠금(Lock)</font>기법이 있다.

---
싱글 스레드 게임 서버
많은 상용 게임 서버에서 CPU가 여러 코어로 구성되어 있으므로 게임 서버를 싱글 스레드로 구동하는 경우 코어 하나만 사용하데 되는 비효율성 문제가 생긴다. 그래서 ==싱글 스레드 서버를 구동하는 경우 CPU 갯수만큼 프로세스를 띄우는 것==이 일반적이다.![[Pasted image 20231107142351.png]]
- 각 서버 프로세스는 방을 여러 개 가지고 방에서는 플레이어 하나 이상이 싱글 플레이 혹은 멀티 플레이를 한다.
- 플레이어 정보를 로딩할 때 발생하는 디바이스 타임을 처리하는 과정에서 큰 시리얼 병목이 발생한다. 이를 해결하기 위해 비동기 함수나 코루틴 같은 것을 사용하기도 한다.
- 방 갯수만큼 스레드나 프로세스가 있으면 스레드나 프로세사 간 컨텍스트 스위치의 횟수가 증가.
- 같은 동시 접속자를 처리하는 서버라고 하더라도 실제로 처리할 수 있는 동시 접속자 수를 크게 떨어뜨림.
>[!tip] 코루틴
>용어의 일종으로, 코루틴 용어가 만들어지고 어셈블리 프로그램에서부터 적용된 개념이다. <font color="red">함께 동작하며 규칙이 있는 일의 순서</font>를 뜻한다.
>샐행의 지연과 재개를 허용함으로써, 비선점적 멀티테스킹을 위한 서브 루틴을 일반화한 컴퓨터 프로그램 구성요소이다.
>
>비선점적 멀티태스킹
>- 비선점형 : 하나의 프로세스가 CPU를 할당받으면 종료되기 전까지 다른 프로세스가 CPU를 강제로 차지할 수 없다.(코루틴)
>- 선점형 : 하나의 프로세스가 다른 프로세스 대신에 프로세서(CPU)를 강제로 차지할 수 있다.(쓰레드)


